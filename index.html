<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Self‚ÄëCare Pet</title>
  <style>
    :root{
      --bg:#fff7fb; /* very light pink */
      --panel:#ffeaf3; /* blush */
      --ink:#4b3b4a; /* soft cocoa */
      --accent:#ff8fb3; /* candy pink */
      --accent-2:#ffd1e0; /* baby pink */
      --ok:#64d699; /* mint */
      --warn:#ffcf54; /* soft yellow */
      --bad:#ff6b6b; /* coral */
      --shadow: 0 10px 30px rgba(255,143,179,.25);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink); font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "SF Pro Rounded", "SF Pro", sans-serif;
    }
    .container{max-width:1100px; margin:0 auto; padding:18px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:44px; height:44px; border-radius:50%; background:linear-gradient(145deg, var(--accent), var(--accent-2)); box-shadow:var(--shadow); display:grid; place-items:center; font-weight:800; color:white}
    h1{font-size:20px; margin:0}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    button, .btn{
      border:0; padding:10px 14px; background:var(--accent); color:white; border-radius:14px; box-shadow:var(--shadow); cursor:pointer; font-weight:600;
    }
    button.ghost{background:white; color:var(--ink); border:2px solid var(--accent-2)}
    button.link{background:transparent; color:var(--accent); box-shadow:none; padding:6px 8px}

    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:16px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .card h2{margin:0 0 10px; font-size:18px}

    /* Pet area */
    .pet-wrap{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 700px){ .pet-wrap{grid-template-columns:1fr} }

    .room{position:relative; height:280px; border-radius:var(--radius); background:linear-gradient(#fff7fb 55%, #ffe1ee); overflow:hidden; display:flex; align-items:center; justify-content:center}
    .floor{position:absolute; left:0; right:0; bottom:0; height:34%; background:repeating-linear-gradient( 0deg, #ffe1ee 0 8px, #ffd8e8 8px 16px)}
    .pet{
      position:relative; width:160px; height:160px; border-radius:50%; background:radial-gradient(circle at 45% 40%, #fff, #ffd8e8); box-shadow: 0 12px 24px rgba(0,0,0,.08); display:grid; place-items:center; transition:.3s transform;
    }
    .pet.happy{animation: bounce 1.4s infinite}
    .pet.sad{animation: sad 2s infinite}
    .face{position:relative; width:110px; height:110px}
    .eye{position:absolute; width:18px; height:18px; background:#2f2430; border-radius:50%}
    .eye.left{left:28px; top:36px}
    .eye.right{right:28px; top:36px}
    .blush{position:absolute; width:26px; height:14px; background:rgba(255,143,179,.35); border-radius:50%; filter:blur(1px)}
    .blush.l{left:18px; top:64px}
    .blush.r{right:18px; top:64px}
    .mouth{position:absolute; left:50%; top:64px; width:28px; height:18px; transform:translateX(-50%); border:3px solid #2f2430; border-top:0; border-radius:0 0 18px 18px; background:#2f2430}
    .mouth.neutral{height: 3px; width:30px; top:68px; background:#2f2430; border:0}
    .tears{position:absolute; width:10px; height:18px; background:#7fc7ff; left:24px; top:54px; border-radius:6px; opacity:.9; box-shadow: 50px 0 0 #7fc7ff}

    .bow{position:absolute; top:-8px; right:16px; width:56px; height:40px; display:none}
    .bow svg{width:100%; height:100%}
    .item{position:absolute; opacity:.95}

    .hud{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px}
    .stat{background:white; border:2px solid var(--accent-2); padding:8px 10px; border-radius:12px; display:flex; align-items:center; gap:8px; font-weight:700}
    .bar{position:relative; height:10px; background:white; border-radius:16px; border:2px solid var(--accent-2); overflow:hidden; width:100%}
    .bar > span{position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, var(--ok), var(--accent)); transition: width .4s}

    /* Tasks */
    .task{display:flex; align-items:center; gap:10px; background:white; border:2px solid var(--accent-2); border-radius:14px; padding:10px; margin-bottom:10px}
    .task .name{font-weight:700}
    .task .unit{opacity:.7; font-size:12px}
    .task .grow{flex:1}
    .task .counter{display:flex; align-items:center; gap:8px}
    .pill{
      background:var(--accent); color:white; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700
    }

    .shop-grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    .shop-item{background:white; border:2px solid var(--accent-2); border-radius:14px; padding:10px; display:grid; place-items:center; text-align:center}
    .price{font-weight:800; margin-top:6px}

    dialog{border:0; border-radius:18px; padding:0; box-shadow:var(--shadow); max-width:600px}
    dialog .d{padding:16px; background:var(--panel)}
    dialog::backdrop{background:rgba(0,0,0,.2)}

    .muted{opacity:.7}

    @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    @keyframes sad{0%,100%{transform:translateY(0)}50%{transform:translateY(3px)}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">‚òÖ</div>
        <div>
          <h1>Self‚ÄëCare Pet</h1>
          <div class="muted" style="font-size:12px">Totally free. All data stays in your browser (localStorage).</div>
        </div>
      </div>
      <div class="controls">
        <button id="btnShop" class="ghost">Shop</button>
        <button id="btnInventory" class="ghost">Inventory</button>
        <button id="btnSettings" class="ghost">Settings</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="pet-wrap">
          <div class="room" id="room">
            <div class="pet" id="pet">
              <div class="face" id="face">
                <div class="eye left"></div>
                <div class="eye right"></div>
                <div class="blush l"></div>
                <div class="blush r"></div>
                <div class="mouth" id="mouth"></div>
                <div class="tears" id="tears" style="display:none"></div>
              </div>
              <div class="bow" id="bow">
                <!-- cute bow -->
                <svg viewBox="0 0 120 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15 40 C 10 10, 40 0, 55 25 C 70 50, 45 65, 20 60 Z" fill="#ff8fb3"/>
                  <path d="M105 40 C 110 10, 80 0, 65 25 C 50 50, 75 65, 100 60 Z" fill="#ff8fb3"/>
                  <circle cx="60" cy="40" r="12" fill="#ff6fa8"/>
                </svg>
              </div>
            </div>
            <div class="floor"></div>
          </div>

          <div>
            <h2 style="display:flex; align-items:center; gap:8px">
              <span id="petName">Rosie</span>
              <button id="rename" class="link">rename</button>
            </h2>
            <div class="hud">
              <div class="stat">üí∞ <span id="coins">0</span></div>
              <div class="stat" style="flex:1">Mood
                <div class="bar" style="flex:1"><span id="moodBar"></span></div>
              </div>
              <div class="stat">üî• Streak: <span id="streak">0</span></div>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
              <button id="feedBtn">Feed snack (1üçé)</button>
              <button id="resetDay" class="ghost">Reset day</button>
            </div>
            <p class="muted" style="font-size:12px; margin-top:8px">Tip: Complete your daily tasks to earn coins. Spend coins in the Shop on food or decor. Food gives a small mood boost for today; decor can be equipped from Inventory. Daily progress resets automatically each new day.</p>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Today's Tasks</h2>
        <div id="tasks"></div>
        <div style="display:flex; gap:8px; margin-top:6px">
          <button id="addTask" class="ghost">Add Task</button>
          <button id="weeklyView" class="ghost">Weekly Stats</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Shop Modal -->
  <dialog id="shop">
    <div class="d">
      <h2>Shop</h2>
      <p class="muted" style="margin-top:-6px">Spend coins on snacks or decor. Snacks give a <b>+10% mood</b> boost for today (stackable up to +30%).</p>
      <div class="shop-grid" id="shopGrid"></div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button class="ghost" onclick="closeDialog('shop')">Close</button>
      </div>
    </div>
  </dialog>

  <!-- Inventory Modal -->
  <dialog id="inventory">
    <div class="d">
      <h2>Inventory</h2>
      <div id="inventoryList"></div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button class="ghost" onclick="closeDialog('inventory')">Close</button>
      </div>
    </div>
  </dialog>

  <!-- Settings / Add Task Modal -->
  <dialog id="settings">
    <div class="d">
      <h2>Settings</h2>
      <details>
        <summary><b>Edit Tasks</b></summary>
        <form id="taskForm" style="margin-top:10px; display:grid; gap:8px">
          <label>Task name <input required id="tName" placeholder="e.g., Hydration"/></label>
          <label>Type
            <select id="tType">
              <option value="checkbox">Checkbox (done/not done)</option>
              <option value="counter">Counter (target number)</option>
            </select>
          </label>
          <label>Target (for counter)
            <input id="tTarget" type="number" min="1" value="8"/>
          </label>
          <label>Unit (for counter)
            <input id="tUnit" placeholder="cups, minutes‚Ä¶"/>
          </label>
          <label>Coins on completion
            <input id="tCoins" type="number" min="1" value="10"/>
          </label>
          <button type="submit">Add task</button>
        </form>
      </details>
      <details style="margin-top:10px">
        <summary><b>Danger zone</b></summary>
        <button class="ghost" id="wipeData" style="margin-top:8px">Reset ALL data</button>
      </details>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button class="ghost" onclick="closeDialog('settings')">Done</button>
      </div>
    </div>
  </dialog>

  <!-- Weekly Modal (simple) -->
  <dialog id="weekly">
    <div class="d">
      <h2>This Week</h2>
      <div id="weekStats"></div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px">
        <button class="ghost" onclick="closeDialog('weekly')">Close</button>
      </div>
    </div>
  </dialog>

  <script>
    // === Quick notes ===
    // ‚Ä¢ Everything saves locally to your browser (localStorage). No servers, no accounts.
    // ‚Ä¢ Edit or add tasks in Settings ‚Üí Edit Tasks. Counter tasks complete when value >= target.
    // ‚Ä¢ Coins are granted once per day per task when it first completes.
    // ‚Ä¢ Daily progress resets automatically when the calendar date changes.

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const todayStr = () => new Date().toLocaleDateString('en-CA'); // YYYY-MM-DD

    const DEFAULT_TASKS = [
      { id: id(), name: 'Calories within 1200‚Äì1500', type: 'checkbox', target: 1, unit: '', coins: 15 },
      { id: id(), name: 'Workout minutes', type: 'counter', target: 60, unit: 'min', coins: 12 },
      { id: id(), name: 'Strength training', type: 'checkbox', target: 1, unit: '', coins: 10 },
      { id: id(), name: 'Hydration', type: 'counter', target: 8, unit: 'cups', coins: 8 },
      { id: id(), name: 'Study', type: 'counter', target: 45, unit: 'min', coins: 10 },
      { id: id(), name: 'Read', type: 'counter', target: 20, unit: 'min', coins: 6 },
      { id: id(), name: 'Eat mostly whole foods', type: 'checkbox', target: 1, unit: '', coins: 8 },
    ];

    const SHOP_ITEMS = [
      { id: 'food_apple', name: 'Apple snack', kind: 'food', price: 8, desc: '+10% mood today' },
      { id: 'food_tea', name: 'Herbal tea', kind: 'food', price: 10, desc: '+10% mood today' },
      { id: 'acc_bow', name: 'Pink bow', kind: 'accessory', price: 30, desc: 'Wearable bow üéÄ' },
      { id: 'dec_plant', name: 'Plant', kind: 'decor', price: 24, desc: 'Cute room plant' },
      { id: 'dec_rug', name: 'Rug', kind: 'decor', price: 20, desc: 'Fluffy rug' },
      { id: 'dec_lamp', name: 'Lamp', kind: 'decor', price: 26, desc: 'Warm lamp' },
    ];

    let state = loadState();
    ensureToday();
    renderAll();

    // ===== STATE =====
    function defaultState(){
      const tasks = DEFAULT_TASKS.map(t=>({...t}));
      return {
        date: todayStr(),
        coins: 0,
        petName: 'Rosie',
        streak: { count: 0, lastDate: todayStr() },
        tempMoodBoost: 0, // 0..30 (percent)
        inventory: { food_apple: 0, food_tea: 0 },
        owned: { acc_bow: false, dec_plant: false, dec_rug: false, dec_lamp: false },
        equipped: { acc_bow: false, dec_plant: false, dec_rug: false, dec_lamp: false },
        tasks,
        progress: Object.fromEntries(tasks.map(t=>[t.id,{ value:0, completed:false, rewarded:false }])) ,
        history: {} // date -> { completed: N, total: M }
      }
    }

    function loadState(){
      try{
        const raw = localStorage.getItem('selfcare_pet_state');
        if(!raw) return defaultState();
        const s = JSON.parse(raw);
        // Backfill new tasks if code updated
        const byName = Object.fromEntries((s.tasks||[]).map(t=>[t.name,t]));
        DEFAULT_TASKS.forEach(dt=>{ if(!byName[dt.name]){ s.tasks.push({...dt}); s.progress[dt.id]={value:0,completed:false,rewarded:false}; } })
        return s;
      }catch(e){
        console.warn('loadState error', e); return defaultState();
      }
    }

    function save(){ localStorage.setItem('selfcare_pet_state', JSON.stringify(state)); }

    function ensureToday(){
      const today = todayStr();
      if(state.date !== today){
        // Save yesterday to history
        const pct = completionPercent();
        state.history[state.date] = { completed: Math.round(pct*100)/100, total: 1 };
        // Streak logic
        const d1 = new Date(state.date);
        const d2 = new Date(today);
        const diff = (d2 - d1) / (1000*60*60*24);
        if(diff === 1 && pct >= 0.7){ state.streak.count += 1; }
        else if(diff === 1){ state.streak.count = 0; }
        state.streak.lastDate = today;
        // Reset progress for new day
        state.date = today;
        state.tempMoodBoost = 0;
        for(const id in state.progress){ state.progress[id] = { value:0, completed:false, rewarded:false }; }
        save();
      }
    }

    function id(){ return Math.random().toString(36).slice(2,9); }

    // ===== RENDER =====
    function renderAll(){
      $('#petName').textContent = state.petName;
      $('#coins').textContent = state.coins;
      $('#streak').textContent = state.streak.count;
      renderTasks();
      renderPet();
      renderShop();
      renderInventory();
      save();
    }

    function renderTasks(){
      const root = $('#tasks');
      root.innerHTML = '';
      state.tasks.forEach(task=>{
        const pr = state.progress[task.id] || { value:0, completed:false, rewarded:false };
        const taskEl = document.createElement('div');
        taskEl.className = 'task';
        const done = task.type==='checkbox' ? pr.value>=1 : pr.value>=task.target;
        const completePill = done ? `<span class="pill">‚úì +${task.coins}</span>` : '';
        taskEl.innerHTML = `
          <div class="grow">
            <div class="name">${task.name}</div>
            ${task.type==='counter' ? `<div class="muted">${pr.value}/${task.target} ${task.unit||''}</div>` : ''}
          </div>
          ${task.type==='counter'
            ? `<div class="counter">
                 <button class="ghost" data-act="minus">‚àí</button>
                 <div style="min-width:36px; text-align:center">${pr.value}</div>
                 <button data-act="plus">+</button>
               </div>`
            : `<label style="display:flex; align-items:center; gap:8px">
                 <input type="checkbox" ${pr.value>=1?'checked':''} data-act="toggle" />
                 <span class="muted">mark done</span>
               </label>`
          }
          ${completePill}
          <button class="link" data-act="remove" title="Delete task">üóëÔ∏è</button>
        `;
        // events
        taskEl.addEventListener('click', (e)=>{
          const act = e.target.getAttribute('data-act'); if(!act) return;
          if(act==='plus'){ pr.value = Math.min(pr.value+1, task.target*2); onProgress(task, pr); }
          if(act==='minus'){ pr.value = Math.max(pr.value-1, 0); onProgress(task, pr); }
          if(act==='toggle'){ pr.value = e.target.checked ? 1 : 0; onProgress(task, pr); }
          if(act==='remove'){
            if(confirm('Delete this task?')){
              // remove task
              state.tasks = state.tasks.filter(t=>t.id!==task.id);
              delete state.progress[task.id];
              renderAll();
            }
          }
        });
        root.appendChild(taskEl);
      });
    }

    function onProgress(task, pr){
      const wasCompleted = pr.completed;
      pr.completed = task.type==='checkbox' ? pr.value>=1 : pr.value>=task.target;
      // Award coins once when first becomes completed today
      if(pr.completed && !wasCompleted && !pr.rewarded){
        state.coins += task.coins;
        pr.rewarded = true;
        celebrate();
      }
      renderPet();
      renderAll();
    }

    function completionPercent(){
      const total = state.tasks.length; if(total===0) return 0;
      const done = state.tasks.filter(t=>{
        const pr = state.progress[t.id];
        return t.type==='checkbox' ? pr.value>=1 : pr.value>=t.target;
      }).length;
      return done/total;
    }

    function moodPercent(){
      let pct = Math.round(completionPercent()*100);
      pct = Math.min(100, pct + (state.tempMoodBoost||0));
      return pct;
    }

    function renderPet(){
      const pct = moodPercent();
      $('#moodBar').style.width = pct + '%';
      const pet = $('#pet');
      const mouth = $('#mouth');
      const tears = $('#tears');
      pet.classList.remove('happy','sad');
      if(pct >= 70){
        mouth.className='mouth'; // smile (rounded)
        tears.style.display='none';
        pet.classList.add('happy');
      } else if(pct >= 35){
        mouth.className='mouth neutral';
        tears.style.display='none';
      } else {
        mouth.className='mouth';
        mouth.style.height='6px';
        mouth.style.borderRadius='6px/12px';
        tears.style.display='block';
        pet.classList.add('sad');
      }
      // accessory visibility
      $('#bow').style.display = state.equipped.acc_bow ? 'block' : 'none';
      // render decor items in room
      renderDecor();
    }

    function celebrate(){
      // simple burst
      const el = document.createElement('div');
      el.textContent = '‚ú® Great job! +coins';
      el.style.position='fixed'; el.style.left='50%'; el.style.top='80px'; el.style.transform='translateX(-50%)';
      el.style.background='white'; el.style.border='2px solid var(--accent-2)'; el.style.padding='8px 12px'; el.style.borderRadius='999px'; el.style.boxShadow='var(--shadow)';
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 1200);
    }

    function renderDecor(){
      const room = $('#room');
      // remove old .item
      $$('.item').forEach(n=>n.remove());
      if(state.equipped.dec_rug){
        const rug = document.createElement('div'); rug.className='item';
        rug.style.width='220px'; rug.style.height='60px'; rug.style.borderRadius='30px'; rug.style.background='#ffd6e7'; rug.style.left='calc(50% - 110px)'; rug.style.bottom='22%';
        room.appendChild(rug);
      }
      if(state.equipped.dec_plant){
        const plant = document.createElement('div'); plant.className='item';
        plant.style.width='60px'; plant.style.height='90px'; plant.style.left='16px'; plant.style.bottom='26%'; plant.style.display='grid'; plant.style.placeItems='end';
        plant.innerHTML = `<div style="width:40px; height:40px; background:#7bd389; border-radius:50%"></div>
                           <div style="width:18px; height:28px; background:#a8683b; border-radius:4px"></div>`;
        room.appendChild(plant);
      }
      if(state.equipped.dec_lamp){
        const lamp = document.createElement('div'); lamp.className='item';
        lamp.style.width='26px'; lamp.style.height='120px'; lamp.style.right='20px'; lamp.style.bottom='25%';
        lamp.innerHTML = `<div style="width:26px; height:26px; background:#ffdf90; border-radius:50%"></div>
                          <div style="width:6px; height:94px; background:#caaea1; margin:0 auto"></div>`;
        room.appendChild(lamp);
      }
    }

    function renderShop(){
      const grid = $('#shopGrid'); if(!grid) return; grid.innerHTML='';
      SHOP_ITEMS.forEach(it=>{
        const el = document.createElement('div'); el.className='shop-item';
        el.innerHTML = `
          <div style="font-size:36px">${iconFor(it)}</div>
          <div style="font-weight:700; margin-top:6px">${it.name}</div>
          <div class="muted" style="font-size:12px">${it.desc}</div>
          <div class="price">${it.price} coins</div>
          <button ${canBuy(it)?'':'disabled class="ghost"'} data-id="${it.id}">Buy</button>
        `;
        el.querySelector('button').addEventListener('click', ()=>buy(it));
        grid.appendChild(el);
      })
    }

    function canBuy(it){
      if(it.kind!=='food' && state.owned[it.id]) return false;
      return state.coins >= it.price;
    }

    function buy(it){
      if(!canBuy(it)) return;
      state.coins -= it.price;
      if(it.kind==='food'){ state.inventory[it.id] = (state.inventory[it.id]||0)+1; }
      if(it.kind==='decor' || it.kind==='accessory'){ state.owned[it.id] = true; }
      renderAll();
    }

    function iconFor(it){
      switch(it.id){
        case 'food_apple': return 'üçé';
        case 'food_tea': return 'üçµ';
        case 'acc_bow': return 'üéÄ';
        case 'dec_plant': return 'ü™¥';
        case 'dec_rug': return 'üß∂';
        case 'dec_lamp': return 'üõãÔ∏è';
      }
      return '‚ú®';
    }

    function renderInventory(){
      const root = $('#inventoryList'); if(!root) return; root.innerHTML='';
      const foods = Object.entries(state.inventory).filter(([,qty])=>qty>0);
      const owns = Object.entries(state.owned).filter(([,v])=>v);

      const group = (title, content)=>{
        const box = document.createElement('div'); box.className='card'; box.style.background='white'; box.style.margin='8px 0';
        box.innerHTML = `<h3 style="margin:0 0 6px; font-size:16px">${title}</h3>`;
        box.appendChild(content); return box;
      }

      const f = document.createElement('div');
      if(foods.length===0) f.innerHTML = '<div class="muted">No food yet.</div>';
      foods.forEach(([id,qty])=>{
        const it = SHOP_ITEMS.find(x=>x.id===id);
        const row = document.createElement('div'); row.className='task';
        row.innerHTML = `<div class="grow">${iconFor(it)} ${it.name} √ó ${qty}</div><button data-id="${id}">Use</button>`;
        row.querySelector('button').addEventListener('click', ()=>useFood(id));
        f.appendChild(row);
      })

      const e = document.createElement('div');
      if(owns.length===0) e.innerHTML = '<div class="muted">No decor or accessories yet.</div>';
      owns.forEach(([id])=>{
        const it = SHOP_ITEMS.find(x=>x.id===id);
        const equipped = !!state.equipped[id];
        const row = document.createElement('div'); row.className='task';
        row.innerHTML = `<div class="grow">${iconFor(it)} ${it.name}</div><button data-id="${id}">${equipped?'Unequip':'Equip'}</button>`;
        row.querySelector('button').addEventListener('click', ()=>toggleEquip(id));
        e.appendChild(row);
      })

      root.appendChild(group('Food', f));
      root.appendChild(group('Decor & Accessories', e));
    }

    function useFood(id){
      if((state.inventory[id]||0)<=0) return;
      state.inventory[id] -= 1;
      state.tempMoodBoost = Math.min(30, (state.tempMoodBoost||0) + 10);
      renderAll();
    }

    function toggleEquip(id){
      state.equipped[id] = !state.equipped[id];
      renderAll();
    }

    // ===== EVENTS =====
    $('#btnShop').addEventListener('click', ()=>openDialog('shop'));
    $('#btnInventory').addEventListener('click', ()=>{ renderInventory(); openDialog('inventory'); });
    $('#btnSettings').addEventListener('click', ()=>openDialog('settings'));
    $('#weeklyView').addEventListener('click', ()=>{ renderWeek(); openDialog('weekly'); });

    $('#rename').addEventListener('click', ()=>{
      const newName = prompt("Pet's name?", state.petName);
      if(newName){ state.petName = newName.slice(0,20); renderAll(); }
    });

    $('#feedBtn').addEventListener('click', ()=>{
      if((state.inventory.food_apple||0) + (state.inventory.food_tea||0) <= 0){
        alert('No snacks yet! Buy some in the Shop.'); return;
      }
      // Prefer apples first
      if((state.inventory.food_apple||0)>0) useFood('food_apple'); else useFood('food_tea');
    });

    $('#resetDay').addEventListener('click', ()=>{
      if(confirm('Reset today\'s progress?')){
        for(const id in state.progress){ state.progress[id] = { value:0, completed:false, rewarded:false }; }
        state.tempMoodBoost = 0; renderAll();
      }
    });

    $('#addTask').addEventListener('click', ()=>openDialog('settings'));

    $('#taskForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = $('#tName').value.trim(); if(!name) return;
      const type = $('#tType').value;
      const target = Number($('#tTarget').value)||1;
      const unit = $('#tUnit').value.trim();
      const coins = Math.max(1, Number($('#tCoins').value)||5);
      const t = { id:id(), name, type, target, unit, coins };
      state.tasks.push(t);
      state.progress[t.id] = { value:0, completed:false, rewarded:false };
      $('#tName').value='';
      renderAll();
      alert('Task added!');
    });

    $('#wipeData')?.addEventListener('click', ()=>{
      if(confirm('Really delete all saved data? This cannot be undone.')){
        localStorage.removeItem('selfcare_pet_state');
        state = defaultState();
        renderAll();
        alert('Data cleared.');
      }
    });

    function openDialog(id){ document.getElementById(id).showModal(); }
    function closeDialog(id){ document.getElementById(id).close(); }

    // Weekly stats (very simple: shows last 7 saved days incl. today)
    function renderWeek(){
      const root = $('#weekStats'); root.innerHTML='';
      const days = [];
      const today = new Date(todayStr());
      for(let i=6;i>=0;i--){
        const d = new Date(today); d.setDate(today.getDate()-i);
        const key = d.toLocaleDateString('en-CA');
        let pct;
        if(key===state.date){ pct = completionPercent(); }
        else if(state.history[key]){ pct = state.history[key].completed; }
        else { pct = 0; }
        const row = document.createElement('div'); row.className='task';
        row.innerHTML = `<div class="grow">${key}</div><div class="pill" style="background:${pct>=0.7?'var(--ok)':pct>=0.35?'var(--warn)':'var(--bad)'}">${Math.round(pct*100)}%</div>`;
        root.appendChild(row);
      }
    }

    // Auto-save on visibility change
    document.addEventListener('visibilitychange', save);
  </script>
</body>
</html>
